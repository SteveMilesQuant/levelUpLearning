name: New Server Setup

on:
  workflow_dispatch:

jobs:
  Yum:
    runs-on: [new-runner]
    steps:
      - name: Set up docker
        run: |
          sudo yum update -y
          sudo yum install -y \
            git \
            tar \
            unzip \
            libicu \
            libunwind \
            libcurl \
            jq \
            hostname \
            sudo \
            curl \
            gcc \
            glibc \
            libgcc \
            make \
            which

  Docker:
    needs: [Yum]
    runs-on: [new-runner]
    steps:
      - name: Set up docker
        run: |
          sudo yum install -y docker
          sudo service docker start

  Nginx:
    needs: [Yum]
    runs-on: [new-runner]
    steps:
      - name: Set up nginx
        run: |
          sudo amazon-linux-extras install -y nginx1
          sudo mv /home/ec2-user/lul-scripts/nginx.conf /etc/nginx/nginx.conf
          sudo mv /home/ec2-user/lul-scripts/lul_nginx_ec2.conf /etc/nginx/conf.d/lul_nginx_ec2.conf

  Deploy:
    needs: [Docker]
    uses: ./.github/workflows/deploy.yml
    with:
      runner: new-runner
