{% extends 'base.html' %}

{% block content %}
  <span class='content-body'>
    <div>
      <h1><span>Camp</span></h1>
      <hr class='h-divider'></hr>
    </div>
    <div hidden>
      <span><strong>ID: </strong><span id='camp-id'></span></span>
    </div>
    <div>
      <span><strong>Program Title: </strong><span id='program-title'></span></span>
    </div>
    <div>
      <span><strong>Instructors: </strong></span>
    </div>
    <div id='instructors-box' class='bordered-box'>
      <!-- List of instructors assigned to this camp here -->
      <div class='selectable' onclick='unhide("add-instructor");'>+ Add Instructor</div>
    </div>
    <div id='camp-delete'>
      <button class='selectable' onclick="confirmDeleteCamp();">
        <span><img class='small-button' src="{{ url_for('images', path='/cancel.png') }}" alt='Delete'/></span>
        <span><strong>Delete Camp</strong></span>
      </button>
    </div>
  </span>
  <div class="v-divider"></div>
  <span class='content-body'>
    <div class='content-item'><h1>Level Schedules</h1></div>
    <div class='content-item'><table id='levels-table'>
      <!-- Levels table rows inserted here -->
    </table></div>
  </span>
  <div class='pop-up' id='add-instructor' hidden>
    <div>
      <h1>Add instructor</h1>
      <hr class='h-divider'></hr>
    </div>
    <div class='search-box'>
      <span><img class='small-button' src="{{ url_for('images', path='/search.png') }}" alt='Search'/></span>
      <span><p contenteditable=true id='add-instructor-search'></p></span>
      <span><button class='selectable' onclick='window.allInstructorsList.resetSearchBox();'>
        <img class='small-button' src="{{ url_for('images', path='/cancel.png') }}" alt='Cancel'/>
      </button></span>
    </div>
    <div id='add-instructor-list'>
      <!-- List of all possible instructors inserted here -->
    </div>
    <div>
      <span><button class='selectable' onclick='hide("add-instructor"); postCampInstructor(); window.allInstructorsList.reset();'>
        <img class='small-button' src="{{ url_for('images', path='/confirm.png') }}" alt='Submit'/>
      </button></span>
      <span><button class='selectable' onclick='hide("add-instructor"); window.allInstructorsList.reset();'>
        <img class='small-button' src="{{ url_for('images', path='/cancel.png') }}" alt='Cancel'/>
      </button></span>
    </div>
  </div>
{% endblock %}

{% block script %}
<script src="{{ url_for('js', path='/searchlist.js') }}"></script>
<script src="{{ url_for('js', path='/filtertable.js') }}"></script>
<script>
  // One-time setup
  window.onload = function() {
    commonOnLoad();

    campId = getCampIdStr();
    document.getElementById('camp-id').innerText = campId;

    colMeta = [];
    colMeta.push(new FilterTableColumn('Title', DisplayType.Simple, 'title', null, true));
    colMeta.push(new FilterTableColumn('Start Time', DisplayType.Datetime, 'levelSchedule.start_time', null, true));
    colMeta.push(new FilterTableColumn('End Time', DisplayType.Datetime, 'levelSchedule.end_time', null, true));

    let htmlTable = document.getElementById('levels-table');
    window.userTable = new FilterTable(colMeta, htmlTable, 0, null, null);

    http.get('/camps/' + campId).then((camp) => {
      http.get('/programs/' + camp.program_id).then((program) => {
        document.getElementById('program-title').innerText = program.title;
        http.get('/programs/' + camp.program_id + '/levels').then((levelList) => {
          for (let level of levelList) {
            http.get('/camps/' + campId + '/levels/' + level.id).then((levelSchedule) => {
              level.levelSchedule = levelSchedule;
              addLevelToTable(level);
            });
          }
        });
      });

      http.get('/camps/' + campId + '/instructors').then((instructorList) => {
        for (const instructor of instructorList) {
          addInstructorToList(instructor);
        }
      });
    });

    let htmlInstructorList = document.getElementById('add-instructor-list');
    htmlInstructorList.classList.add('listbox');
    let instructorSearchBox = document.getElementById('add-instructor-search');
    window.allInstructorsList = new SearchList(htmlInstructorList, instructorSearchBox);
    http.get('/instructors').then((instructorList) => {
      for (const instructor of instructorList) {
        window.allInstructorsList.appendValue(instructor.id, instructor.full_name);
      }
    });
  }

  function getCampIdStr() {
    const urlAsArray = document.URL.split("/");
    return urlAsArray[urlAsArray.indexOf("schedule")+1];
  }

  function addLevelToTable(level) {
    let campId = document.getElementById('camp-id').innerHTML;
    let newRow = window.userTable.appendRow(level);
    let startTime = newRow.cells[1].firstChild;
    let endTime = newRow.cells[2].firstChild;

    // Add edit/confirm/cancel buttons off the right side
    let newCol = newRow.insertCell();

    let editButton = document.createElement('button');
    let editImage = document.createElement('img');
    editButton.classList.add('selectable');
    editImage.classList.add('small-button');
    editImage.src = '{{ url_for("images", path="/pencil.png") }}';
    editImage.alt = 'Edit';
    editButton.appendChild(editImage);

    let confirmButton = document.createElement('button');
    let confirmImage = document.createElement('img');
    confirmButton.hidden = true;
    confirmButton.classList.add('selectable');
    confirmImage.classList.add('small-button');
    confirmImage.src = '{{ url_for("images", path="/confirm.png") }}';
    confirmImage.alt = 'Submit';
    confirmButton.appendChild(confirmImage);

    let cancelButton = document.createElement('button');
    let cancelImage = document.createElement('img');
    cancelButton.hidden = true;
    cancelButton.classList.add('selectable');
    cancelImage.classList.add('small-button');
    cancelImage.src = '{{ url_for("images", path="/cancel.png") }}';
    cancelImage.alt = 'Cancel';
    cancelButton.appendChild(cancelImage);

    editButton.onclick = function () {
      editButton.hidden = true;
      confirmButton.hidden = false;
      cancelButton.hidden = false;
      startTime.disabled = false;
      endTime.disabled = false;
    }

    confirmButton.onclick = function () {
      confirmButton.hidden = true;
      cancelButton.hidden = true;
      startTime.disabled = true;
      endTime.disabled = true;

      let levelScheduleData = new LevelSchedule(startTime.value, endTime.value);
      http.put('/camps/' + campId + '/levels', level.id, levelScheduleData).then((levelSchedule) => {
        startTime.value = levelSchedule.start_time;
        endTime.value = levelSchedule.end_time;
        editButton.hidden = false;
      });
    }

    cancelButton.onclick = function () {
      confirmButton.hidden = true;
      cancelButton.hidden = true;
      startTime.disabled = true;
      endTime.disabled = true;

      http.get('/camps/' + campId + '/levels/' + level.id).then((levelSchedule) => {
        startTime.value = levelSchedule.start_time;
        endTime.value = levelSchedule.end_time;
        editButton.hidden = false;
      });
    }

    newCol.appendChild(editButton);
    newCol.appendChild(confirmButton);
    newCol.appendChild(cancelButton);
  }

  function addInstructorToList(instructor) {
    let instructorBox = document.getElementById('instructors-box');

    let div = document.createElement('div');
    div.instructor = instructor;
    if (instructor.is_primary) {
      div.innerText = instructor.full_name + ' (primary)';
      instructorBox.primary_instructor_box = div;
    }
    else {
      div.innerText = instructor.full_name;
      div.classList.add('selectable');
      div.onclick = function () {
        if (confirm('Make ' + this.instructor.full_name + ' the primary instructor?')) {
          let instructorBox = document.getElementById('instructors-box');
          let campId = document.getElementById('camp-id').innerHTML;
          let campData = new CampData(campId, this.instructor.id);
          http.put('/camps', campId, campData).then((camp) => {
            instructorBox.primary_instructor_box.innerText = instructorBox.primary_instructor_box.instructor.full_name;
            instructorBox.primary_instructor_box.instructor.is_primary = false;
            instructorBox.primary_instructor_box.classList.add('selectable');
            instructorBox.primary_instructor_box.onlick = this.onclick;
            this.innerText = this.instructor.full_name + ' (primary)';
            this.instructor.is_primary = true;
            this.classList.remove('selectable');
            instructorBox.primary_instructor_box = this;
            this.onclick = function () { }
          });
        }
      }
    }
    instructorBox.insertBefore(div, instructorBox.lastElementChild);
  }

  function postCampInstructor() {
    let campId = document.getElementById('camp-id').innerHTML;
    let selectedInstructor = window.newCampInstructorList.selectedRow;
    http.post('/camps/' + campId + '/instructors/' + selectedInstructor.id, null).then((instructor) => {
      addInstructorToList(instructor);
    });
  }

  function confirmDeleteCamp() {
    let campId = document.getElementById('camp-id').innerHTML;
    if (confirm('Are you sure you want to delete this camp?')) {
      http.delete('/camps', campId);
      http.redirect('/schedule');
    }
  }
</script>
{% endblock %}
