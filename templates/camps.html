{% extends 'base.html' %}

{% block content %}
  <span class='sidebar'>
    <div class='sidebar-item'>
      <h1>Filters</h1>
      <hr class='h-divider'></hr>
    </div>
    <div class='sidebar-item' id='filters-box'>
      <!-- Camp filters added here -->
    </div>
  </span>
  <div class='content-body'>
    <div class='content-item'><h1>Available Camps</h1></div>
    <div class='content-item'><div class='search-box'>
      <span><img class='small-button' src="{{ url_for('images', path='/search.png') }}" alt='Search'/></span>
      <span><p contenteditable=true id='search-box-text'></p></span>
      <span><span class='selectable' onclick='window.campsTable.resetSearchBox();'>
        <img class='small-button' src="{{ url_for('images', path='/cancel.png') }}" alt='Cancel'/>
      </span></span>
    </div></div>
    <div class='content-item'><div id='camps-table'>
      <!-- Camps table rows inserted here -->
    </div></div>
  </div>
{% endblock %}

{% block script %}
<script src="{{ url_for('js', path='/filtertable.js') }}"></script>
<script src="{{ url_for('js', path='/searchlist.js') }}"></script>
<script>
  // One-time setup
  window.onload = function() {
    commonOnLoad();

    colMeta = [];
    colMeta.push(new FilterTableColumn('Title', DisplayType.Simple, 'h2', 'program.title', null, true));
    colMeta.push(new FilterTableColumn('Primary Instructor', DisplayType.Simple, 'span', 'primary_instructor.full_name', FilterType.CheckBoxes, true));
    colMeta.push(new FilterTableColumn('Tags', DisplayType.Simple, 'span', 'program.tags', FilterType.Tags, true));
    colMeta.push(new FilterTableColumn('Grade Range', DisplayType.Range, 'span', 'program.grade_range', FilterType.IntRange, false));
    colMeta.push(new FilterTableColumn('Start Time', DisplayType.Datetime, 'span', 'first_level_schedule.start_time', null, true));

    let htmlTable = document.getElementById('camps-table');
    let filtersBox = document.getElementById('filters-box');
    let tableSearchBox = document.getElementById('search-box-text');
    window.campsTable = new FilterTable(colMeta, htmlTable, 0, filtersBox, tableSearchBox);

    http.get('/camps').then((campList) => {
      for (let camp of campList) {
        http.get('/programs/' + camp.program_id).then((program) => {
          camp.program = program;
          http.get('/programs/' + camp.program_id + '/levels').then((levelList) => {
            http.get('/camps/' + camp.id + '/levels/' + levelList[0].id).then((firstLevelSchedule) => {
              camp.first_level_schedule = firstLevelSchedule;
              http.get('/camps/' + camp.id + '/instructors/' + camp.primary_instructor_id).then((instructor) => {
                camp.primary_instructor = instructor;
                addCampToTable(camp);
              });
            });
          });
        });
      }
    });
  }

  function addCampToTable(camp) {
    let newRow = window.campsTable.appendRow(camp);

    let title = newRow.childNodes[0];
    let instructor = newRow.childNodes[1];
    let tags = newRow.childNodes[2];
    let grade_range = newRow.childNodes[3];
    let start_time = newRow.childNodes[4];
    insertCampRowContent(camp.id, newRow, title, instructor, tags, grade_range, start_time);
  }
</script>
{% endblock %}
