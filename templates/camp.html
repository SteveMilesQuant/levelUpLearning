{% extends 'base.html' %}

{% block content %}
  <span class='content-body'>
    <div class='content-item'>
      <h1 id='program-title'></h1>
      <hr class='h-divider'></hr>
    </div>
    <div class='content-item'>
      <textarea wrap='soft' class='longtext-box' id='program-description' readonly></textarea>
    </div>
    <div class='content-item'>
      <span class='content-subitem'><strong>Grade Range: </strong><span id='program-grade-range'></span></span>
      <span class='content-subitem'><strong>Tags: </strong><span id='program-tags'></span></span>
    </div>
    <div class='content-item'>
      <strong>Instructors</strong>
    </div>
    <div class='content-item'><div id='instructors-box' class='listbox'>
      <!-- List of instructors assigned to this camp here -->
    </div></div>
    <div class='content-item'>
      <button class='selectable big-button' onclick='unhide("enroll-student");'><h2>Enroll Student</h2></button>
    </div>
  </span>
  <div class="v-divider"></div>
  <span class='content-body'>
    <div class='content-item'>
      <h2>Schedule</h2>
      <hr class='h-divider'></hr>
    </div>
    <div class='content-item calendar'>
      <ul class='calendar-header'>
        <li>M</li>
        <li>Tu</li>
        <li>W</li>
        <li>Th</li>
        <li>F</li>
      </ul>
      <ul class='calendar-body' id='levels-calendar'>
      </ul>
    </div>
    <div class='content-item hidden-level' hidden>
      <h2 id='level-title'>Level 1</h2>
      <hr class='h-divider'></hr>
    </div>
    <div class='content-item hidden-level' hidden>
      <textarea wrap='soft' class='longtext-box' id='level-description' readonly></textarea>
    </div>
  </span>
  <div class='pop-up' id='enroll-student' hidden>
    <div>
      <h1>Enroll Student</h1>
      <hr class='h-divider'></hr>
    </div>
    <div><strong>Camp grade range </strong><strong id='enroll-camp-grade-range'></strong></div>
    <div id='enroll-student-list' class='listbox listbox-popup'>
      <!-- List of all the user's students which haven't been enrolled inserted here -->
    </div>
    <div id='already-enrolled-students' hidden>
      <strong>Already enrolled: </strong>
      <!-- List of all the user's students which are already enrolled inserted here -->
    </div>
    <div>
      <span><button class='selectable' onclick='enrollStudent(); resetEnrollStudent();'>
        <img class='small-button' src="/images/confirm.png" alt='Submit'/>
      </button></span>
      <span><button class='selectable' onclick='resetEnrollStudent();'>
        <img class='small-button' src="/images/cancel.png" alt='Cancel'/>
      </button></span>
    </div>
  </div>
{% endblock %}

{% block script %}
<script src="/js/searchlist.js"></script>
<script src="/js/calendar.js"></script>
<script>
  // One-time setup
  window.onload = function() {
    commonOnLoad();

    let campId = getCampIdStr();

    let calendarBox = document.getElementById('levels-calendar');
    window.levelsCalendar = new Calendar(calendarBox, startDay=1, skipDays=[0, 7]);
    http.get('/camps/' + campId).then((camp) => {
      window.camp = camp;

      // Display the program information
      const programPromise = http.get('/programs/' + camp.program_id);
      programPromise.then((program) => {
        let programTitle = document.getElementById('program-title');
        programTitle.innerText = program.title;
        let programDesc = document.getElementById('program-description');
        programDesc.innerText = program.description;
        let programTags = document.getElementById('program-tags');
        programTags.innerText = program.tags;
        let programGradeRange = document.getElementById('program-grade-range');
        let gradeRange = program.grade_range[0] + ' to ' + program.grade_range[1];
        programGradeRange.innerText = gradeRange;

        let enrollGradeRange = document.getElementById('enroll-camp-grade-range');
        enrollGradeRange.innerText = gradeRange;
      });

      // Add students to "enroll student" popup
      const studentPromise = http.get('/students');
      Promise.all([studentPromise, programPromise]).then((values) => {
        const studentList = values[0];
        const program = values[1];

        let htmlStudentList = document.getElementById('enroll-student-list');
        window.enrollStudentList = new SearchList(htmlStudentList, null);

        for (const student of studentList) {
          http.get('/students/' + student.id + '/camps').then((campList) => {
            if (campList.find(element => element.id === camp.id) === undefined) {
              // Student not already in this camp
              let studentNameText = student.name;
              if (student.grade_level < program.grade_range[0] || student.grade_level > program.grade_range[1]) {
                studentNameText += ' (Grade ' + student.grade_level;
                studentNameText += ' - Special Approval Required)';
              }
              window.enrollStudentList.appendValue(student.id, studentNameText);
            }
            else {
              // Student already in this camp
              addEnrolledStudent(student);
            }
          });
        }
      });

      // Get program levels
      http.get('/programs/' + camp.program_id + '/levels').then((levelList) => {
        for (let level of levelList) {
          http.get('/camps/' + campId + '/levels/' + level.id).then((levelSchedule) => {
            let eventBox = window.levelsCalendar.addEvent(level.title, levelSchedule.start_time, levelSchedule.end_time);
            if (eventBox) {
              eventBox.levelId = level.id;
              eventBox.onclick = function() {
                let programId = window.camp.program_id;
                http.get('/programs/' + programId + '/levels/' + this.levelId).then((level) => {
                  displayLevel(level);
                });
              };
            }
          });
        }
      });

    });

    // Get list of instructors
    http.get('/camps/' + campId + '/instructors').then((instructorList) => {
      for (const instructor of instructorList) {
        addInstructorToList(instructor);
      }
    });

  }

  function getCampIdStr() {
    const urlAsArray = document.URL.split("/");
    return urlAsArray[urlAsArray.indexOf("camps")+1];
  }

  function addInstructorToList(instructor) {
    let instructorBox = document.getElementById('instructors-box');

    let text = null;
    if (instructor.is_primary) {
      text = document.createElement('strong');
      text.innerText = instructor.full_name + ' (primary)';
    }
    else {
      text = document.createElement('p');
      text.classList.add('selectable');
      text.innerText = instructor.full_name;
    }

    let link = document.createElement('a');
    link.classList.add('selectable');
    link.href = '/instructors/' + instructor.id;
    link.appendChild(text);

    let box = document.createElement('div');
    box.appendChild(link);
    if (instructor.is_primary) {
      instructorBox.insertBefore(box, instructorBox.firstElementChild);
    }
    else {
      instructorBox.appendChild(box);
    }
  }

  function displayLevel(level) {
    let levelTitle = document.getElementById('level-title');
    levelTitle.innerText = 'Level ' + level.list_index + ': ' + level.title;
    let levelDesc = document.getElementById('level-description');
    levelDesc.innerText = level.description;

    let elemList = document.getElementsByClassName('hidden-level');
    for (elem of elemList) {
      elem.hidden = false;
    }
    for (elem of elemList) {
      elem.classList.remove('hidden-level');
    }
  }

  function addEnrolledStudent(student) {
    let studentNameBox = document.createElement('strong');
    studentNameBox.innerText = student.name;

    let enrolledStudentsList = document.getElementById('already-enrolled-students');
    enrolledStudentsList.appendChild(studentNameBox);

    if (!enrolledStudentsList.hidden) {
      studentNameBox.innerText = ', ' + studentNameBox.innerText;
    }
    enrolledStudentsList.hidden = false;
  }

  function resetEnrollStudent() {
    hide('enroll-student');
    window.enrollStudentList.reset();
  }


  function enrollStudent() {
    let campId = window.camp.id;
    let selectedStudent = window.enrollStudentList.selectedRow;

    // TODO: create requirement for this value
    if (selectedStudent) {
      http.post('/camps/' + campId + '/students/' + selectedStudent.id, null).then((student) => {
        selectedStudent.remove();
        addEnrolledStudent(student);
        alert('Successfully enrolled ' + student.name);
      });
    }
  }

</script>
{% endblock %}
