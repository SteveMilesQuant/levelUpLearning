{% extends 'base.html' %}

{% block content %}
  <span class='sidebar' id='sidebar'>
    <div class='sidebar-title'><h1>Filters</h1></div>
    <hr class='h-divider'></hr>
  </span>
  <div class='content-body'>
    <div class='content-item'><h1>Programs</h1></div>
    <div class='search-box'>
      <span class='search-box-item'><img class='small-button' src="{{ url_for('images', path='/search.png') }}" alt='Search'/></span>
      <span class='search-box-item search-box-text' contenteditable=true id='search-box-text'></span>
      <span class='search-box-item'><button class='selectable' onclick='window.userTable.resetSearchBox();'>
        <img class='small-button' src="{{ url_for('images', path='/cancel.png') }}" alt='Cancel'/>
      </button></span>
    </div>
    <div class='content-item'><table id='programs-table'>
      <tr class='selectable' onclick='unhide("new-program");'><td>+ Add Program</td></tr>
    </table></div>
    <div class='pop-up' id='new-program' hidden>
      <div class='pop-up-item'>
        <h1>New Program</h1>
        <hr class='h-divider'></hr>
      </div>
      <div class='pop-up-item'>
        <div class='pop-up-subitem'><strong >Title:</strong></div>
        <div class='pop-up-subitem pop-up-text'contenteditable='true' id='new-program-title'></div>
        <div class='pop-up-subitem'><strong >Tags:</strong></div>
        <div class='pop-up-subitem pop-up-text'contenteditable='true' id='new-program-tags'></div>
        <div class='pop-up-subitem'><strong>From grade:</strong></div>
        <div class='pop-up-subitem'><select type='select' id='new-program-from-grade'>
          <option value="0">K</option>
          {% for grade in range(1,13) %}
            <option value="{{grade}}" {% if grade == 6 %} selected {% endif %}>{{grade}}</option>
          {% endfor %}
        </select></div>
        <div class='pop-up-subitem'><strong>To grade:</strong></div>
        <div class='pop-up-subitem'><select type='select' id='new-program-to-grade'>
          <option value="0">K</option>
          {% for grade in range(1,13) %}
            <option value="{{grade}}" {% if grade == 8 %} selected {% endif %}>{{grade}}</option>
          {% endfor %}
        </select></div>
        <div class='pop-up-subitem'>
          <span><button class='selectable' onclick='postProgram();'>
            <img class='small-button' src="{{ url_for('images', path='/confirm.png') }}" alt='Submit'/>
          </button></span>
          <span><button class='selectable' onclick='resetNewProgram();'>
            <img class='small-button' src="{{ url_for('images', path='/cancel.png') }}" alt='Cancel'/>
          </button></span>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
  // One-time setup
  window.onload = function() {
    colMeta = [];
    colMeta.push(new FilterTableColumn('Title', template`${0}`, 'title', null, true));
    colMeta.push(new FilterTableColumn('Tags', template`${0}`, 'tags', FilterType.Tags, true));
    colMeta.push(new FilterTableColumn('Grade Range', template`${0} to ${1}`, 'grade_range', FilterType.IntRange, false));

    var htmlTable = document.getElementById('programs-table');
    var sidebar = document.getElementById('sidebar');
    var searchBox = document.getElementById('search-box-text');
    window.userTable = new FilterTable(colMeta, htmlTable, -1, sidebar, searchBox); // -1 for row shift - we have one extra final static row for "Add Program"

    http.get('/programs').then((programList) => { for (const program of programList) addProgramToTable(program); });
  }

  function resetNewProgram() {
    hide("new-program");
    document.getElementById('new-program-title').innerHTML = "";
    document.getElementById('new-program-tags').innerHTML = "";
    document.getElementById('new-program-from-grade').selectedIndex = 6;
    document.getElementById('new-program-to-grade').selectedIndex = 8;
    // Description intentionally left off "new program"
  }

  function addProgramToTable(program) {
    var newRow = window.userTable.appendRow(program);
    newRow.programId = program.id;
    newRow.classList.add('selectable');

    commonOnClick = function() {
      row = this.parentNode;
      window.open('/programs/' + row.programId, '_blank');
    };
    for (var col of newRow.childNodes) col.onclick = commonOnClick;

    // Add a delete button off the right side
    var newCol = newRow.insertCell();
    var newButton = document.createElement('button');
    newButton.classList.add('selectable');
    newButton.innerHTML = 'Delete';
    newButton.onclick = function () {
      var row = this.parentNode.parentNode;
      var programTitle = row.cells[0].innerHTML;
      if (confirm('Are you sure you want to delete the program "' + programTitle + '"?')) {
        http.delete('/programs', row.programId);
        row.remove();
      }
    }
    newCol.appendChild(newButton);
  }

  function postProgram() {
    programTitle = document.getElementById('new-program-title').innerHTML;
    programTags = document.getElementById('new-program-tags').innerHTML;
    programFromGrade = document.getElementById('new-program-from-grade').selectedIndex;
    programToGrade = document.getElementById('new-program-to-grade').selectedIndex;
    programDescription = ""; // intentionally left off "new program"

    // TODO: create requirement for this value
    if (programTitle != "") {
      programData = new ProgramData(programTitle, programTags, [programFromGrade, programToGrade], programDescription);

      http.post('/programs', programData).then((program) => {
        resetNewProgram();
        addProgramToTable(program);
        window.open('/programs/' + program.id, '_blank');
      });
    }
  }
{% endblock %}
